version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: ecom_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "39432:5432"
    networks:
      - ecom_network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: ecom_redis
    ports:
      - "39379:6379"
    networks:
      - ecom_network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Auth Service
  auth_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_auth_service
    environment:
      SERVICE_NAME: auth_service
      DATABASE_URL: postgresql://${POSTGRES_USER:-ecom_user}:${POSTGRES_PASSWORD:-ecom_password}@postgres:5432/${POSTGRES_DB:-ecommerce}
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      ROOT_PATH: /api/auth
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ecom_network
    command: uvicorn auth_service.main:app --host 0.0.0.0 --port 8000 --reload

  # Product Service
  product_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_product_service
    environment:
      SERVICE_NAME: product_service
      DATABASE_URL: postgresql://${POSTGRES_USER:-ecom_user}:${POSTGRES_PASSWORD:-ecom_password}@postgres:5432/${POSTGRES_DB:-ecommerce}
      REDIS_URL: redis://redis:6379
      ROOT_PATH: /api/products
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ecom_network
    command: uvicorn product_service.main:app --host 0.0.0.0 --port 8001 --reload

  # Cart Service
  cart_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_cart_service
    environment:
      SERVICE_NAME: cart_service
      REDIS_URL: redis://redis:6379
      PRODUCT_SERVICE_URL: http://product_service:8001
      ROOT_PATH: /api/cart
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ecom_network
    command: uvicorn cart_service.main:app --host 0.0.0.0 --port 8002 --reload

  # Order Service
  order_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_order_service
    environment:
      SERVICE_NAME: order_service
      DATABASE_URL: postgresql://${POSTGRES_USER:-ecom_user}:${POSTGRES_PASSWORD:-ecom_password}@postgres:5432/${POSTGRES_DB:-ecommerce}
      REDIS_URL: redis://redis:6379
      PRODUCT_SERVICE_URL: http://product_service:8001
      COUPON_SERVICE_URL: http://coupon_service:8007
      NOTIFICATION_SERVICE_URL: http://notification_service:8008
      ROOT_PATH: /api/orders
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ecom_network
    command: uvicorn order_service.main:app --host 0.0.0.0 --port 8003 --reload

  # Payment Service
  payment_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_payment_service
    environment:
      SERVICE_NAME: payment_service
      DATABASE_URL: postgresql://${POSTGRES_USER:-ecom_user}:${POSTGRES_PASSWORD:-ecom_password}@postgres:5432/${POSTGRES_DB:-ecommerce}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_your_stripe_key}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_your_webhook_secret}
      ROOT_PATH: /api/payment
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecom_network
    command: uvicorn payment_service.main:app --host 0.0.0.0 --port 8004 --reload

  # Delivery Service
  delivery_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_delivery_service
    environment:
      SERVICE_NAME: delivery_service
      DATABASE_URL: postgresql://${POSTGRES_USER:-ecom_user}:${POSTGRES_PASSWORD:-ecom_password}@postgres:5432/${POSTGRES_DB:-ecommerce}
      ROOT_PATH: /api/delivery
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecom_network
    command: uvicorn delivery_service.main:app --host 0.0.0.0 --port 8005 --reload

  # Review Service
  review_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_review_service
    environment:
      SERVICE_NAME: review_service
      DATABASE_URL: postgresql://${POSTGRES_USER:-ecom_user}:${POSTGRES_PASSWORD:-ecom_password}@postgres:5432/${POSTGRES_DB:-ecommerce}
      ROOT_PATH: /api/reviews
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecom_network
    command: uvicorn review_service.main:app --host 0.0.0.0 --port 8006 --reload

  # Coupon Service
  coupon_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_coupon_service
    environment:
      SERVICE_NAME: coupon_service
      DATABASE_URL: postgresql://${POSTGRES_USER:-ecom_user}:${POSTGRES_PASSWORD:-ecom_password}@postgres:5432/${POSTGRES_DB:-ecommerce}
      ROOT_PATH: /api/coupons
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecom_network
    command: uvicorn coupon_service.main:app --host 0.0.0.0 --port 8007 --reload

  # Notification Service
  notification_service:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ecom_notification_service
    environment:
      SERVICE_NAME: notification_service
      SMTP_SERVER: ${SMTP_SERVER}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      ROOT_PATH: /api/notifications
    networks:
      - ecom_network
    command: uvicorn notification_service.main:app --host 0.0.0.0 --port 8008 --reload

  # Customer Frontend (PWA)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    container_name: ecom_frontend
    environment:
      NEXT_PUBLIC_API_URL: http://alzainportal.shopinbh.com/api
      NODE_ENV: development
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    ports:
      - "39100:3000"
    networks:
      - ecom_network
    command: npm run dev -- -H 0.0.0.0

  # Admin Portal
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
      target: development
    container_name: ecom_admin
    environment:
      NEXT_PUBLIC_API_URL: http://alzainportal.shopinbh.com/api
      NODE_ENV: development
    volumes:
      - ./admin:/app
      - /app/node_modules
      - /app/.next
    networks:
      - ecom_network
    command: npm run dev -- -H 0.0.0.0

  # NGINX Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: ecom_nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "39080:80"
      - "39101:3001"
      - "39443:443"
    depends_on:
      - auth_service
      - product_service
      - cart_service
      - order_service
      - payment_service
      - delivery_service
      - review_service
      - coupon_service
      - notification_service
      - frontend
      - admin
    networks:
      - ecom_network

networks:
  ecom_network:
    driver: bridge

volumes:
  postgres_data:
